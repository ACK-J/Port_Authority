<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All in One Port-Scan Test</title>
    <style>
        main {
            width: 500px;
            margin: auto;
            padding: 20px;
            padding-top: 10px;

            border: solid black 5px;
            border-radius: 10px;

            background-color: #da5a5a;

            color: white;
            font-weight: bold;
            text-align: center;
        }

        #custom_button {
            padding: 6px;
            background-color: #e7e7e7;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <main>
        <h1>All in One Port-Scan Test</h1>

        <button id="custom_button" onclick="custom_scan();">Port Scan My Internal Network!</button>
        
        <p>
            By clicking the button above, you understand that this is a portscanning test that happens inside your browser and is specifically built to test all the possible ways a site can port scan you in one easy location. 
            It will also try to reach out to specific domains that are known for distributing privacy-invasive scripts but will not attempt to download these scripts. NO DATA WILL EVER BE LOGGED OR SENT TO ME!
        </p>
        <a href="https://addons.mozilla.org/en-US/firefox/addon/port-authority/">
            <img src="https://blog.mozilla.org/addons/files/2020/04/get-the-addon-fx-apr-2020.svg" alt="for Firefox" height="60px" />
        </a>
        <p>
            If you download the Port Authority add-on, your browser will block all malicious port scans and scripts.
        </p>
        <h2 id="requestsmade" hidden>
            Requests Made
        </h2>
        <div id="results" style="padding-top: 10px; font-weight: bold;"></div>
    </main>

    <div id="testdiv" hidden></div>

    <script>
        /* DOM nodes */
        const trigger_portscan_button = document.getElementById("custom_button");
        const res_div = document.getElementById("results");
        const test_div = document.getElementById("testdiv");

        /* The scanner needs these global variables for an ugly hack. */
        var last_scanobj_index = 0;
        var scanobjs = {};
        function PortScanner(ip, port)
        {
            // Verify port format
            if (isNaN(port) || port <= 0 || port > 65535) {
                alert("Bad port number");
            }
            const host = ip + ":" + port;
            this.host = host;
            this.total_time = null;

            this.runHTTP = function () {

                /* Save this object in the global directory (UGLY HACK). */
                var our_scanobj_index = last_scanobj_index;
                last_scanobj_index++;
                scanobjs[our_scanobj_index] = this;

                /* Create the div to load the image, passing our object's index into
                    the global directory so that it can be retrieved. */
                test_div.innerHTML = '<img src="http://' + host + 
                    '" alt="" onerror="error_handler(' + our_scanobj_index + ');" />';
                res_div.innerHTML += "http://" + host + "<br />";

                // XXX: What's the right way to do this in JS?
                var thiss = this;
                setTimeout(
                    function () {
                        /* This will be non-null if the event hasn't fired yet. */
                        if (scanobjs[our_scanobj_index]) {
                            scanobjs[our_scanobj_index] = null;
                        }
                    },
                    10000
                );
            }

            this.runHTTPS = function () {

                /* Save this object in the global directory (UGLY HACK). */
                var our_scanobj_index = last_scanobj_index;
                last_scanobj_index++;
                scanobjs[our_scanobj_index] = this;

                /* Create the div to load the image, passing our object's index into
                    the global directory so that it can be retrieved. */
                test_div.innerHTML = '<img src="https://' + host + 
                    '" alt="" onerror="error_handler(' + our_scanobj_index + ');" />';

                res_div.innerHTML += "https://" + host + "<br />";

                // XXX: What's the right way to do this in JS?
                var thiss = this;
                setTimeout(
                    function () {
                        /* This will be non-null if the event hasn't fired yet. */
                        if (scanobjs[our_scanobj_index]) {
                            scanobjs[our_scanobj_index] = null;
                        }
                    },
                    10000
                );
            }

            this.ws = function() {
            return new Promise((resolve, reject) => {
                var ws = new WebSocket("ws://" + host + '/')
                res_div.innerHTML += "ws://" + host + "<br />";
                ws.onerror = function() {
                // close the socket before we return
                ws.close()
                }
            })
            }

            this.wss = function() {
            return new Promise((resolve, reject) => {
                var ws = new WebSocket("wss://" + host + '/')
                res_div.innerHTML += "wss://" + host + "<br />";
                ws.onerror = function() {
                // close the socket before we return
                ws.close()
                }
            })
            }
        }



        function error_handler(index)
        {
            /* Get the PortScanner object back. */
            var thiss = scanobjs[index];

            /* If it's null, the scan timed out. */
            if (thiss == null) {
                return;
            }
            /* Set it to null so the timeout knows we handled it. */
            scanobjs[index] = null;
        }

        function custom_scan()
        {
            const ips = [{"127.0.0.1": 80}, {"127.0.0.1": 65535}, {"0.0.0.0": 80}, {"localhost.": 80}, {"localhost.": 8080}, {"localhost": 8080}, {"localhost": 8081}, {"localhost": 8082}, {"localhost": 8083}, {"localhost": 8084}, {"localhost": 8085}, {"LoCALhOst": 443}, {"10.0.0.1": 455}, {"10.255.22.33": 80}, {"192.168.1.1": 443}, {"192.168.1.255":6463}, {"172.17.100.155": 4444}, {"172.31.255.255": 8081}, {"172.031.33.33": 445}, {"169.254.1.0": 547}, {"169.254.1.0": 21}, {"169.254.1.0": 194}];
            const scripts = ["fp.disney.go.com", "h.chase.co.uk", "analytics.vacations.united.com", "tmx.bestbuy.com", "thm12.visa.com", "tmetrix.my.chick-fil-a.com", "cfa.fidelity.com", "content22.citibank.com", "deviceauth.dmv.ca.gov", "dfp.t-mobile.at", "src.ebay-us.com", "fp.disney.go.com", "fp.ups.com"];

            trigger_portscan_button.disabled = true;
            document.getElementById("requestsmade").hidden = false;

            res_div.innerText = "";

            for(const item of ips){
                const [ip, port] = Object.entries(item)[0];
                const scanner = new PortScanner(ip, port);

                scanner.runHTTP();
                scanner.runHTTPS();
                scanner.ws();
                scanner.wss();
            }

            for(const host of scripts){
                const scanner = new PortScanner(host, 443);
                scanner.runHTTPS();
            }
            
            trigger_portscan_button.disabled = false;
        }
    </script>
</body>
</html>
